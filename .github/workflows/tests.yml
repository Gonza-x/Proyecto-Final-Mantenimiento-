name: Tests PHP

# Ejecutar en cada push y pull request
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: hou_panama_tours
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸ˜ Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: mbstring, mysqli, pdo, pdo_mysql
        coverage: xdebug
        tools: composer

    - name: ğŸ“¦ Instalar dependencias de Composer
      run: |
        if [ -f composer.json ]; then
          composer install --prefer-dist --no-progress
        else
          echo "No hay composer.json, creando uno bÃ¡sico..."
          composer init --no-interaction --require="phpunit/phpunit:^9.0"
          composer require --dev phpunit/phpunit
          composer require --dev squizlabs/php_codesniffer
        fi

    - name: ğŸ—„ï¸ Importar base de datos
      run: |
        mysql -h 127.0.0.1 -u root -proot hou_panama_tours < hou_panama_tours.sql

    - name: âš™ï¸ Configurar archivo de configuraciÃ³n
      run: |
        if [ -f config.php ]; then
          sed -i "s/localhost/127.0.0.1/g" config.php
          sed -i "s/\$password = '[^']*'/\$password = 'root'/g" config.php
          echo "âœ… Archivo config.php actualizado para CI"
        fi

    - name: ğŸ” Verificar sintaxis PHP
      run: |
        echo "ğŸ” Verificando sintaxis de archivos PHP..."
        find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \; | tee syntax-check.log
        if grep -q "Parse error" syntax-check.log; then
          echo "âŒ Errores de sintaxis encontrados"
          exit 1
        else
          echo "âœ… Sintaxis correcta en todos los archivos"
        fi

    - name: ğŸ§ª Ejecutar tests unitarios (PHPUnit)
      run: |
        if [ -d tests ]; then
          vendor/bin/phpunit tests/ --testdox
        else
          echo "âš ï¸ No hay carpeta de tests, creando tests bÃ¡sicos..."
          mkdir -p tests
          cat > tests/BasicTest.php << 'EOF'
        <?php
        use PHPUnit\Framework\TestCase;

        class BasicTest extends TestCase {
            public function testDatabaseConnection() {
                require_once __DIR__ . '/../config.php';
                $conn = new mysqli($host ?? 'localhost', $usuario ?? 'root', $password ?? '', $bd ?? 'hou_panama_tours');
                $this->assertEquals(0, $conn->connect_errno, "Error conectando a la base de datos");
                $conn->close();
            }

            public function testIndexFileExists() {
                $this->assertFileExists(__DIR__ . '/../index.php');
            }

            public function testLoginFileExists() {
                $this->assertFileExists(__DIR__ . '/../login.php');
            }
        }
        EOF
          vendor/bin/phpunit tests/ --testdox
        fi

    - name: ğŸ“Š AnÃ¡lisis de cÃ³digo (PHP_CodeSniffer)
      run: |
        if [ -f vendor/bin/phpcs ]; then
          echo "ğŸ“Š Analizando calidad de cÃ³digo..."
          vendor/bin/phpcs --standard=PSR12 --extensions=php --ignore=vendor/ . || true
        fi

    - name: ğŸ” Verificar seguridad bÃ¡sica
      run: |
        echo "ğŸ” Verificando problemas de seguridad comunes..."
        
        # Buscar cÃ³digo potencialmente peligroso
        echo "Buscando eval()..."
        ! grep -r "eval(" --include="*.php" --exclude-dir=vendor . || echo "âš ï¸ Advertencia: eval() encontrado"
        
        echo "Buscando $_GET sin sanitizar..."
        ! grep -r '\$_GET\[' --include="*.php" --exclude-dir=vendor . | grep -v "htmlspecialchars\|filter_input\|mysqli_real_escape_string" || echo "âš ï¸ Advertencia: $_GET sin sanitizar"
        
        echo "Buscando SQL directo sin prepared statements..."
        ! grep -r "mysqli_query.*\$_" --include="*.php" --exclude-dir=vendor . || echo "âš ï¸ Advertencia: Posible SQL injection"
        
        echo "âœ… VerificaciÃ³n de seguridad completada"

    - name: ğŸŒ Test de archivos estÃ¡ticos
      run: |
        echo "ğŸŒ Verificando archivos estÃ¡ticos..."
        
        # Verificar que las imÃ¡genes existen
        for img in Canal.jpg CastilloSanLorenzo.jpg Coiba.jpg Despedida.jpg EmberaWounaan.jpg IslaIguana.jpg; do
          if [ -f "$img" ]; then
            echo "âœ… $img existe"
          else
            echo "âŒ $img no encontrado"
          fi
        done
        
        # Verificar CSS
        if [ -f style.css ]; then
          echo "âœ… style.css existe"
          # Validar CSS bÃ¡sico
          ! grep -q "syntax error" style.css && echo "âœ… CSS sin errores de sintaxis"
        fi

    - name: ğŸ“ˆ Reporte final
      if: always()
      run: |
        echo "=========================================="
        echo "ğŸ“ˆ REPORTE FINAL DE TESTS"
        echo "=========================================="
        echo "âœ… Tests completados"
        echo "Revisar los logs arriba para detalles"
        echo "=========================================="

    - name: ğŸ’¾ Guardar logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs
        path: |
          syntax-check.log
          *.log
